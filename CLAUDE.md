# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Diablo II Android port project targeting the Retroid Pocket Flip 2 device. The project aims to create a native ARM implementation without emulation, featuring full controller support and modern UI improvements while maintaining LAN multiplayer compatibility.

## Build Commands

### Initial Setup
```bash
# Set up Android development environment
./tools/setup_environment.sh

# Extract game assets (requires legally owned game files)
./tools/extract_assets.sh /path/to/d2/files

# Configure CMake for Android NDK
cmake -B build -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
      -DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-26
```

### Building
```bash
# Build debug APK
./gradlew assembleDebug

# Build release APK
./gradlew assembleRelease

# Build and run unit tests
cd build && cmake .. -DBUILD_TESTS=ON && make
./engine/tests/d2_unit_tests

# Run Android instrumentation tests
./gradlew connectedAndroidTest
```

### Deployment
```bash
# Install to connected device
./gradlew installDebug

# Deploy to specific device
./tools/deploy_to_device.sh

# Generate signed APK for personal use
./gradlew assembleRelease -Pkeystore=$HOME/.android/release.keystore
```

## Architecture

The project follows a native Android implementation approach with these key components:

1. **Core Engine** (C++17)
   - Located in `engine/src/`
   - Game logic, rendering, input handling
   - Uses OpenGL ES 3.0 for graphics
   - Custom MPQ loader for asset extraction

2. **Android Framework** (Kotlin/Java)
   - Located in `android/app/src/`
   - JNI bridge to native engine
   - Android-specific UI and lifecycle management

3. **Asset Pipeline**
   - MPQ extraction tools in `tools/mpq_extractor/`
   - Sprite optimization for mobile GPUs
   - UI asset modification system

4. **Test Framework**
   - Google Test for C++ unit tests
   - Espresso for Android UI tests
   - Test-Driven Development approach per TDD_IMPLEMENTATION_PLAN.md

## Development Priorities

1. **Controller Support**: Primary input method via Xbox-style gamepad
2. **Performance**: Target 60 FPS on Snapdragon processors
3. **Memory Efficiency**: Under 1.5GB RAM usage
4. **Battery Life**: 4+ hours gameplay target
5. **LAN Compatibility**: Maintain protocol compatibility with PC version

## Key Technical Standards

- **C++ Standard**: C++17
- **Android Min SDK**: 26 (Android 8.0)
- **Android Target SDK**: 33 (Android 13)
- **Graphics API**: OpenGL ES 3.0
- **Audio**: Oboe library
- **Build Tools**: CMake 3.22.1 + Gradle
- **NDK Version**: r25c or newer

## Testing Requirements

- Maintain 90%+ test coverage
- All new features require tests first (TDD)
- Run full test suite before commits
- Test on physical Retroid Pocket Flip 2 device when possible

## Critical Development Guidelines

### Test-Driven Development (MANDATORY - STRICTLY ENFORCED)

**ABSOLUTE RULES - NO EXCEPTIONS:**

## MANDATORY TDD CHECKPOINT QUESTIONS

### Before Writing Tests:

1. ❓ **"Have I reviewed existing code architecture and interfaces?"**
2. ❓ **"Do I understand the current data structures and types?"**
3. ❓ **"Am I testing against the ACTUAL system, not my assumptions?"**

### Before Writing Implementation:

1. ❓ **"Have I written exactly ONE failing test?"**
2. ❓ **"Have I seen that ONE test fail?"**
3. ❓ **"Am I about to implement ONLY what makes that ONE test pass?"**
4. ❓ **"Will I commit immediately after this test passes?"**

**If ANY answer is "no" - STOP and course-correct.**

## ENFORCED TDD WORKFLOW

**NEVER deviate from this sequence:**

1. **REVIEW existing code** - Understand interfaces, types, and architecture
2. **Write ONE test** (and only one) that matches ACTUAL system structure
3. **Run**: `npm test -- path/to/test.test.ts`
4. **Verify failure** (must see test failure)
5. **Implement minimal code** (only what makes THIS test pass)
6. **Run same command**, verify pass
7. **Commit** with message: "Add [feature] support - RED/GREEN cycle complete"
8. **ONLY THEN** proceed to next test

**CRITICAL**: Each test is a complete story that deserves individual attention, not a step in a batch process.

## CORE TDD RULES

1. **RED-GREEN-REFACTOR ONLY**

   - RED: Write a failing test FIRST (test must fail)
   - GREEN: Write MINIMAL code to make test pass
   - REFACTOR: Clean up code while keeping tests green
   - **VIOLATION**: Writing ANY implementation code before a failing test

2. **TEST IMMUTABILITY**

   - Tests are CONTRACTS - once written, they CANNOT be changed
   - If a test seems wrong, the implementation is wrong, NOT the test
   - **VIOLATION**: Modifying any test to make implementation pass
   - **EXCEPTION**: Only if requirements genuinely changed (must document why)

3. **NO IMPLEMENTATION WITHOUT TESTS**

   - Every line of implementation code MUST have a corresponding test
   - No "temporary" code without tests
   - No "quick fixes" without tests
   - **VIOLATION**: Any implementation code not covered by tests

4. **SINGLE TEST DISCIPLINE**
   - Write exactly ONE test at a time
   - See it fail before writing ANY implementation
   - Implement ONLY what makes that ONE test pass
   - Commit before writing the next test
   - **VIOLATION**: Writing multiple tests before implementing any

## TDD VIOLATIONS TO AVOID

- ❌ Writing implementation then tests
- ❌ Modifying tests to match implementation
- ❌ Skipping tests for "simple" code
- ❌ **Writing multiple tests before implementing any**
- ❌ **Batching RED-GREEN cycles without commits**
- ❌ Commenting out failing tests
- ❌ Writing tests that always pass
- ❌ **Writing tests without understanding existing architecture**
- ❌ **Testing against assumed interfaces instead of actual ones**

## CORRECT TDD EXAMPLE

```typescript
// STEP 0: Review existing Redux state structure
// Check: src/store/slices/librariesSlice.ts shows state.libraries.items[]

// STEP 1: Write exactly ONE failing test
it('should display library name in header', () => {
  const preloadedState = {
    libraries: {
      items: [{ id: '1', name: 'My Library' }], // Matches ACTUAL state shape
      selectedId: null,
      loading: false,
      error: null
    }
  };
  renderWithProviders(<LibraryScreen />, { preloadedState });
  expect(screen.getByText('My Library')).toBeTruthy(); // This MUST fail first
});

// STEP 2: Run test, see failure
// STEP 3: Write minimal implementation
// STEP 4: Test passes
// STEP 5: Commit immediately
// STEP 6: ONLY THEN write next test
```

## DISCIPLINE ENFORCEMENT

**Think of each test as a discipline exercise, not an efficiency optimization.**

- Each RED-GREEN cycle builds muscle memory
- Batching cycles breaks the discipline
- The goal is internalization, not speed


## Current Implementation Status

- **Phase 0**: Environment Setup ✓
  - Project structure created
  - CMake build system configured
  - Google Test integrated
  - CI/CD pipeline established
  
- **Phase 1**: Core Systems (In Progress)
  - MPQ Archive Reading ✓
  - MPQ File Extraction (Next)
  - Sprite Loading System
  - Palette System
  
See `Docs/TDD_IMPLEMENTATION_PLAN.md` for detailed phase breakdown.

## Important Notes

- This is a clean-room implementation - no original Diablo II code
- Users must provide their own legally purchased game files
- Project is for personal use only, not for distribution
- Refer to comprehensive documentation in `Docs/` directory for detailed implementation guides